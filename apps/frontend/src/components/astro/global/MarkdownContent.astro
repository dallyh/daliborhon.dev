---
import * as m from "@daliborhon.dev/i18n/messages";
import type { MarkdownHeading } from "astro";

interface Props {
	tocPosition?: "inside" | "default";
	headings?: MarkdownHeading[];
}

const { tocPosition = "default", headings } = Astro.props;
---

<markdown-content>
	<article class=`md-content prose max-w-none ${tocPosition}` id="article">
		{
			headings && headings.length !== 0 && (
				<div id="toc" class="box">
					<details id="tocDetails" class="max-[1024px]:collapse-arrow bg-base-200 collapse rounded-xl shadow-lg">
						<summary class="collapse-title bg-base-200 text-xl">{m.blog__toc()}</summary>
					</details>
				</div>
			)
		}
		<div id="content">
			<slot />
		</div>
	</article>
</markdown-content>

<script>
	class MarkdownContent extends HTMLElement {
		private details: HTMLDetailsElement | null = null;

		connectedCallback() {
			this.details = this.querySelector<HTMLDetailsElement>("#tocDetails");

			if (!this.details) {
				return;
			}

			this.initToc();

			document.addEventListener("astro:after-swap", () => this.initToc());
		}

		private initToc() {
			if (!this.details) {
				// Check again in case the element is removed
				return;
			}

			const toc = this.querySelector<HTMLElement>(".toc")!;
			this.details.appendChild(toc);

			toc.style.display = "block";

			this.openToc(this.details);
			window.addEventListener("resize", () => this.openToc(this.details!));
		}

		private openToc(details: HTMLDetailsElement) {
			const width = window.innerWidth;

			if (width < 1024) {
				details.open = false;
			} else {
				details.open = true;
			}
		}
	}

	customElements.define("markdown-content", MarkdownContent);
</script>

<style>
	.md-content {
		position: relative;
		width: 100%;
	}

	@media screen and (min-width: 1024px) {
		.md-content {
			&.inside {
				display: grid;
				grid-template-columns: 1fr min-content;
				grid-template-rows: 1fr;
				gap: 2rem;

				#content {
					grid-row: 1;
					grid-column: 1;
				}

				#toc {
					z-index: 2;
					grid-row: 1;
					grid-column: 2;
					position: sticky;
					top: var(--header-height); /* Navbar */
					height: max-content;
					max-height: calc(100vh - var(--header-height) - 1rem);
					width: 300px;
					box-shadow: unset;
					background-color: unset;
				}
			}
		}
	}
</style>

<style is:global>
	.md-content {
		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			position: relative;
			/* Generated by rehype autolinks */

			a {
				margin-left: 0.5rem;
				font-size: 1rem;

				.heading-link-icon {
					background-color: var(--tw-prose-headings);
					position: relative;
					display: inline-block;
					width: 16px;
					height: 16px;
					mask: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>');
					mask-repeat: no-repeat;
					mask-position: center;
					mask-size: cover;
				}
			}
		}

		figure:not([class]) {
			margin: 0;

			img {
				border: 1px solid transparent;
				border-radius: 0.5rem;
			}

			figcaption {
				text-align: center;
			}
		}
	}

	nav.toc {
		display: none; /* This is generated */
		height: max-content;
		max-height: calc(100vh - var(--header-height) - 5rem);
		scrollbar-width: thin;
		overflow-y: scroll;
		padding: 0.725rem;
	}

	#toc {
		summary::marker,
		summary::-webkit-details-marker {
			display: none;
		}

		summary {
			list-style: none;
			pointer-events: none;
		}
	}

	@media screen and (max-width: 1024px) {
		#toc {
			summary::marker,
			summary::-webkit-details-marker {
				display: none;
			}

			details {
				margin-bottom: 1rem;
			}

			summary {
				pointer-events: all;
				padding-left: 1rem;
				margin-bottom: 0;
				position: relative;
				cursor: pointer;
			}
		}
	}
</style>
